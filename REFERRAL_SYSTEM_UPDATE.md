# Обновление реферальной системы

## Описание изменений

Реферальная система была переработана для работы в два этапа:

### 1. Этап - Регистрация неактивного реферала
Когда пользователь переходит по реферальной ссылке:
- Пользователь регистрируется в системе
- Реферал добавляется в таблицу `referrals` с флагом `is_active = 0` (неактивный)
- Реферер получает уведомление: "⏳ @username перешел по вашей реферальной ссылке, но еще не подписался на каналы. Как только подпишется, вы получите +5 ⭐!"
- **Бонус НЕ начисляется**
- Реферал **НЕ учитывается** для условий вывода

### 2. Этап - Активация реферала
После подписки на каналы и нажатия кнопки "Старт":
- Реферал активируется (`is_active = 1`)
- Рефереру начисляется бонус в 5 звезд
- Реферал начинает учитываться для условий вывода
- Реферер получает уведомление: "@username присоединился по вашей ссылке! Вам начислено +5 ⭐."

## Технические изменения

### База данных
1. **Таблица `referrals`**:
   - Добавлено поле `is_active INTEGER DEFAULT 0` - флаг активности реферала
   - Добавлено поле `created_at DATETIME` - время регистрации реферала

2. **Миграция**:
   - Все существующие рефералы автоматически помечаются как активные (`is_active = 1`)

### Функции базы данных (`database/db.py`)

1. **`add_user()`**:
   - Добавлен параметр `is_subscribed: bool = False`
   - Реферал всегда добавляется в таблицу, но статус зависит от подписки
   - Бонусы и уровни обновляются только для активных рефералов

2. **`activate_referral(user_id, bot)`** (новая функция):
   - Активирует неактивного реферала после подписки
   - Обновляет уровень реферера
   - Проверяет достижения

3. **`get_referrals_count(user_id, active_only=True)`**:
   - Добавлен параметр `active_only` (по умолчанию `True`)
   - По умолчанию считает только активных рефералов
   - Для вывода используются только активные рефералы

4. **`get_full_user_info(user_id)`**:
   - Теперь возвращает информацию о статусе каждого реферала
   - Формат: `{"user_id": int, "is_active": bool}`

5. **Обновлены функции**:
   - `get_top_referrers()` - учитывает только активных рефералов
   - `get_daily_referrals_count()` - учитывает только активных рефералов

### Обработчики (`handlers/user_handlers.py`)

1. **`command_start()`** переработан:
   ```python
   # Этап 1: Регистрация без подписки
   - Проверка существования пользователя
   - Регистрация с is_subscribed=False
   - Отправка уведомления о неактивном реферале

   # Этап 2: Проверка подписки
   - Проверка подписки через SubGram

   # Этап 3: Активация реферала
   - Вызов activate_referral()
   - Начисление бонуса
   - Проверка достижений
   - Отправка уведомления об активации
   ```

### Тексты (`lexicon/languages.py`)

Добавлен новый текст для всех языков (ru, en, uk, es):
```python
"referral_pending_notification":
  "⏳ @{username} перешел по вашей реферальной ссылке, но еще не подписался на каналы.
   Как только подпишется, вы получите +{ref_bonus} ⭐!"
```

## Преимущества новой системы

1. ✅ Рефералы регистрируются сразу при переходе по ссылке
2. ✅ Реферер получает уведомление о потенциальном реферале
3. ✅ Защита от накрутки - бонус только после подписки
4. ✅ Для вывода учитываются только активные рефералы
5. ✅ Прозрачность - реферер видит весь процесс

## Тестирование

Для тестирования:
1. Создайте реферальную ссылку
2. Перейдите по ссылке (реферер получит уведомление о неактивном реферале)
3. НЕ подписывайтесь - проверьте, что бонус не начислен
4. Подпишитесь и нажмите /start - проверьте, что бонус начислен

## Обратная совместимость

- Все существующие рефералы автоматически помечены как активные
- Никакие данные не потеряны
- Система работает с существующими пользователями

## Дата обновления
16 октября 2025
